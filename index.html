<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Direct Segments - Enhanced Analytics</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: #1e272e; color: white; padding: 8px 20px; min-height: 35px; display: flex; align-items: center; }
        h1 { margin: 0; font-size: 1.1rem; }
        .controls { padding: 10px 20px; background: white; border-bottom: 1px solid #d1d8dd; }
        select { padding: 8px; width: 250px; font-weight: bold; cursor: pointer; border-radius: 4px; border: 2px solid #2c3e50; }
        .container { display: flex; flex: 1; overflow: hidden; }
        #map { flex: 1.8; background: #f0f0f0; }
        .info-panel { flex: 1.2; padding: 20px; overflow-y: auto; background: white; border-left: 1px solid #d1d8dd; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #2c3e50; color: white; padding: 12px; position: sticky; top: -20px; }
        td { border-bottom: 1px solid #eee; padding: 12px; text-align: center; cursor: pointer; }
        tr:hover { background: #f1f4f6; }
        .active-row { background: #e8f5e9 !important; font-weight: bold; border: 2px solid #00FF00; }
        
        /* Waypoint Label - 배경 제거 및 글자 강조 */
        .wp-label {
            color: #000000;      /* 검정색 글자 */
            font-size: 24px;     /* 기존보다 2배 크기 */
            font-weight: 900;
            white-space: nowrap;
            /* 글자 시인성을 위해 흰색 외곽선 추가 */
            text-shadow: -2px -2px 0 #fff, 2px -2px 0 #fff, -2px 2px 0 #fff, 2px 2px 0 #fff;
        }
    </style>
</head>
<body>

<header><h1>DIRECT SEGMENTS ANALYTICS</h1></header>

<div class="controls">
    <label><small><strong>SELECT SECTOR:</strong></small></label><br>
    <select id="sectorSelect"><option>Loading...</option></select>
</div>

<div class="container">
    <div id="map"></div>
    <div class="info-panel">
        <h2 id="viewTitle" style="font-size: 1.2rem; margin-top: 0;">Sector Details</h2>
        <table>
            <thead><tr><th>Start WP</th><th>End WP</th><th>Saving(lbs)</th><th>Time(m)</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 지도 초기화
    const map = L.map('map', { worldCopyJump: true }).setView([38, 175], 3);
    L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    const atsLayer = L.layerGroup().addTo(map);
    const segmentLayer = L.layerGroup().addTo(map);
    const labelLayer = L.layerGroup().addTo(map);

    let flightData = [];
    let segmentObjects = [];

    // 데이터 불러오기
    fetch('./flight_data.json?v=' + Date.now())
        .then(res => res.json())
        .then(data => {
            flightData = data;
            const select = document.getElementById('sectorSelect');
            select.innerHTML = '';
            data.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.sector;
                opt.textContent = item.sector_name;
                select.appendChild(opt);
            });
            updateView(data[0]);
        });

    document.getElementById('sectorSelect').onchange = function() {
        const selected = flightData.find(d => d.sector === this.value);
        if(selected) updateView(selected);
    };

    function updateView(sectorData) {
        atsLayer.clearLayers();
        segmentLayer.clearLayers();
        labelLayer.clearLayers();
        segmentObjects = [];
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';
        document.getElementById('viewTitle').innerText = sectorData.sector_name + " - All Flights";

        sectorData.flights.forEach(flight => {
            // ATS 루트 표시 (검정색)
            L.polyline(flight.ats_route, {color: '#000', weight: 1.5, opacity: 0.2}).addTo(atsLayer);

            // Direct Segments 표시
            flight.segments.forEach(s => {
                const poly = L.polyline(s.coords, {color: '#3498db', weight: 5, opacity: 0.8}).addTo(segmentLayer);
                
                const row = document.createElement('tr');
                row.innerHTML = `<td>${s.start}</td><td>${s.end}</td><td>${s.fuel.toLocaleString()}</td><td>${s.time}</td>`;
                row.onclick = () => {
                    highlight(poly, s, row);
                };
                tableBody.appendChild(row);
                segmentObjects.push(poly);
            });
        });
    }

    function highlight(poly, data, row) {
        // 초기화
        segmentObjects.forEach(p => p.setStyle({color: '#3498db', weight: 5, opacity: 0.8}));
        labelLayer.clearLayers();
        document.querySelectorAll('tr').forEach(tr => tr.classList.remove('active-row'));

        // #00FF00 하이라이트 및 둥근 끝점
        poly.setStyle({
            color: '#00FF00', 
            weight: 10, 
            opacity: 1, 
            lineCap: 'round'
        });
        poly.bringToFront();
        row.classList.add('active-row');

        // 라벨 및 마커 생성
        addCleanLabel(data.coords[0], data.start);
        addCleanLabel(data.coords[1], data.end);

        map.fitBounds(data.coords, {padding: [150, 150]});
    }

    function addCleanLabel(coord, text) {
        // 1. 글자 라벨 (타원 배경 없음)
        const labelIcon = L.divIcon({
            className: 'custom-wp-label',
            html: `<div class="wp-label">${text}</div>`,
            iconSize: [0, 0],
            iconAnchor: [-15, 35] // 원형 마커 기준 우측 상단으로 위치 조정
        });
        L.marker(coord, { icon: labelIcon }).addTo(labelLayer);

        // 2. 지점 표시를 위한 작은 원형 마커 유지
        L.circleMarker(coord, {
            radius: 6, 
            color: '#000', 
            fillColor: '#00FF00', 
            fillOpacity: 1, 
            weight: 2
        }).addTo(labelLayer);
    }
</script>
</body>
</html>