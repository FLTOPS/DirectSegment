<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Direct Segments - Interactive</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: #1e272e; color: white; padding: 8px 20px; min-height: 35px; display: flex; align-items: center; }
        h1 { margin: 0; font-size: 1.1rem; }
        .controls { padding: 10px 20px; background: white; border-bottom: 1px solid #d1d8dd; }
        select { padding: 6px; width: 400px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; }
        .container { display: flex; flex: 1; overflow: hidden; }
        #map { flex: 1.8; background: #f0f0f0; }
        .info-panel { flex: 1.2; padding: 20px; overflow-y: auto; background: white; border-left: 1px solid #d1d8dd; }
        table { width: 100%; border-collapse: collapse; font-size: 0.82rem; margin-top: 10px; }
        th { background: #34495e; color: white; padding: 10px; position: sticky; top: -20px; }
        td { border-bottom: 1px solid #eee; padding: 10px; text-align: center; cursor: pointer; }
        tr:hover { background: #f1f4f6; }
        .active-row { background: #e8f5e9 !important; font-weight: bold; }
        
        /* Waypoint Label Style */
        .wp-label {
            background: rgba(0, 0, 0, 0.8);
            color: #00FF00;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            border: 1px solid #00FF00;
        }
    </style>
</head>
<body>

<header><h1>DIRECT SEGMENTS DASHBOARD</h1></header>

<div class="controls">
    <label><small><strong>SELECT ROUTE:</strong></small></label><br>
    <select id="routeSelect"><option>Loading...</option></select>
</div>

<div class="container">
    <div id="map"></div>
    <div class="info-panel">
        <h2 id="routeTitle" style="font-size: 1.1rem; margin-top: 0;">Route Analysis</h2>
        <div id="tableContainer">
            <table>
                <thead><tr><th>Start WP</th><th>End WP</th><th>Saving(lbs)</th><th>Time(m)</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { worldCopyJump: true }).setView([38, 175], 3);
    L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    const atsLayer = L.layerGroup().addTo(map);
    const segmentLayer = L.layerGroup().addTo(map);
    const labelLayer = L.layerGroup().addTo(map); // 라벨 전용 레이어

    let flightData = [];
    let polylines = [];

    fetch('./flight_data.json?v=' + Date.now())
        .then(res => res.json())
        .then(data => {
            flightData = data;
            const select = document.getElementById('routeSelect');
            select.innerHTML = '';
            data.forEach((route, idx) => {
                const opt = document.createElement('option');
                opt.value = route.route_id;
                opt.textContent = route.route_name;
                select.appendChild(opt);
                
                // 모든 ATS 루트를 배경에 검정색으로 표시
                if(route.ats_route) {
                    L.polyline(route.ats_route, {color: '#333', weight: 1.2, opacity: 0.25}).addTo(atsLayer);
                }
            });
            displayRoute(data[0]);
        });

    document.getElementById('routeSelect').onchange = function() {
        const selected = flightData.find(r => r.route_id === this.value);
        if(selected) displayRoute(selected);
    };

    function displayRoute(route) {
        segmentLayer.clearLayers();
        labelLayer.clearLayers();
        polylines = [];
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';
        document.getElementById('routeTitle').innerText = route.route_name;

        route.segments.forEach((s, i) => {
            const poly = L.polyline(s.coords, {color: '#3498db', weight: 4, opacity: 0.7}).addTo(segmentLayer);
            polylines.push(poly);

            const row = document.createElement('tr');
            row.innerHTML = `<td>${s.start}</td><td>${s.end}</td><td>${s.fuel.toLocaleString()}</td><td>${s.time}</td>`;
            row.onclick = () => {
                // 하이라이트 초기화 및 적용
                polylines.forEach(p => p.setStyle({color: '#3498db', weight: 4}));
                labelLayer.clearLayers(); // 기존 라벨 제거

                poly.setStyle({color: '#00FF00', weight: 7, opacity: 1}); 
                document.querySelectorAll('tr').forEach(tr => tr.classList.remove('active-row'));
                row.classList.add('active-row');

                // Waypoint 라벨 생성
                createLabel(s.coords[0], s.start);
                createLabel(s.coords[1], s.end);

                map.fitBounds(s.coords, {padding: [150, 150]});
            };
            tableBody.appendChild(row);
        });
    }

    function createLabel(coord, text) {
        const icon = L.divIcon({
            className: 'custom-label',
            html: `<div class="wp-label">${text}</div>`,
            iconSize: [0, 0],
            iconAnchor: [0, 25] // 지점보다 약간 위에 표시
        });
        L.marker(coord, { icon: icon }).addTo(labelLayer);
    }
</script>
</body>
</html>