<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Direct Segments - Aviation Analytics</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; flex-direction: column; }
        
        header { background: #1e272e; color: white; padding: 10px 20px; height: 40px; display: flex; align-items: center; z-index: 1001; }
        h1 { margin: 0; font-size: 1.1rem; }

        .controls { padding: 12px 20px; background: white; border-bottom: 1px solid #d1d8dd; z-index: 1000; }
        select { padding: 8px; width: 300px; font-weight: bold; border: 2px solid #2c3e50; border-radius: 4px; cursor: pointer; }

        .container { display: flex; flex: 1; height: calc(100% - 90px); }
        #map { flex: 1.8; height: 100%; background: #aad3df; position: relative; }
        
        .info-panel { flex: 1.2; padding: 20px; overflow-y: auto; background: white; border-left: 1px solid #d1d8dd; }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #2c3e50; color: white; padding: 12px; position: sticky; top: 0; }
        td { border-bottom: 1px solid #eee; padding: 12px; text-align: center; cursor: pointer; }
        tr:hover { background: #f1f4f6; }
        .active-row { background: #e8f5e9 !important; font-weight: bold; outline: 2px solid #00FF00; }

        .wp-label {
            color: #000000;
            font-size: 24px;
            font-weight: 900;
            white-space: nowrap;
            text-shadow: -2px -2px 0 #fff, 2px -2px 0 #fff, -2px 2px 0 #fff, 2px 2px 0 #fff;
        }
    </style>
</head>
<body>

<header><h1>DIRECT SEGMENTS ANALYTICS</h1></header>

<div class="controls">
    <label><small><strong>SELECT SECTOR:</strong></small></label><br>
    <select id="sectorSelect"><option>Loading Data...</option></select>
</div>

<div class="container">
    <div id="map"></div>
    <div class="info-panel">
        <h2 id="viewTitle" style="font-size: 1.2rem; margin-top: 0;">Sector Details</h2>
        <table>
            <thead><tr><th>Start WP</th><th>End WP</th><th>Saving(lbs)</th><th>Time(m)</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. 지도 초기 설정: 최소 축소 비율(minZoom)과 이동 제한 범위(maxBounds) 설정
    const map = L.map('map', { 
        worldCopyJump: true,
        minZoom: 3, // 너무 작게 축소되지 않도록 제한
        maxBounds: [[-10, 100], [80, 280]], // 항로가 있는 태평양 중심 영역으로 이동 제한
        zoomControl: true 
    }).setView([35, 175], 3);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const atsLayer = L.layerGroup().addTo(map);
    const segmentLayer = L.layerGroup().addTo(map);
    const labelLayer = L.layerGroup().addTo(map);

    let flightData = [];
    let segmentObjects = [];

    fetch('./flight_data.json?t=' + Date.now())
        .then(res => res.json())
        .then(data => {
            flightData = data;
            const select = document.getElementById('sectorSelect');
            select.innerHTML = '';
            data.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.sector;
                opt.textContent = item.sector_name;
                select.appendChild(opt);
            });
            updateView(data[0]);
        });

    document.getElementById('sectorSelect').onchange = function() {
        const selected = flightData.find(d => d.sector === this.value);
        if(selected) updateView(selected);
    };

    function updateView(sectorData) {
        atsLayer.clearLayers();
        segmentLayer.clearLayers();
        labelLayer.clearLayers();
        segmentObjects = [];
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';
        document.getElementById('viewTitle').innerText = sectorData.sector_name;

        let allPoints = [];

        sectorData.flights.forEach(flight => {
            // 2. ATS 루트 표시: 색상을 진하게 하고 weight를 3으로 두껍게 변경
            const atsPoly = L.polyline(flight.ats_route, {
                color: '#000000', 
                weight: 3, 
                opacity: 0.4 
            }).addTo(atsLayer);
            
            allPoints = allPoints.concat(flight.ats_route);

            flight.segments.forEach(s => {
                const poly = L.polyline(s.coords, {color: '#3498db', weight: 5, opacity: 0.8}).addTo(segmentLayer);
                const row = document.createElement('tr');
                row.innerHTML = `<td>${s.start}</td><td>${s.end}</td><td>${s.fuel.toLocaleString()}</td><td>${s.time}</td>`;
                row.onclick = () => highlightSegment(poly, s, row);
                tableBody.appendChild(row);
                segmentObjects.push(poly);
            });
        });

        // 3. 노선 선택 시 전체 항로가 한눈에 들어오도록 지도를 자동 정렬
        if (allPoints.length > 0) {
            map.fitBounds(L.polyline(allPoints).getBounds(), { padding: [30, 30] });
        }
    }

    function highlightSegment(poly, data, row) {
        segmentObjects.forEach(p => p.setStyle({color: '#3498db', weight: 5, opacity: 0.8}));
        labelLayer.clearLayers();
        document.querySelectorAll('tr').forEach(tr => tr.classList.remove('active-row'));

        poly.setStyle({ color: '#00FF00', weight: 12, opacity: 1, lineCap: 'round' });
        poly.bringToFront();
        row.classList.add('active-row');

        addCleanLabel(data.coords[0], data.start);
        addCleanLabel(data.coords[1], data.end);

        map.fitBounds(data.coords, {padding: [150, 150]});
    }

    function addCleanLabel(coord, text) {
        const labelIcon = L.divIcon({
            className: 'custom-wp-label',
            html: `<div class="wp-label">${text}</div>`,
            iconSize: [0, 0],
            iconAnchor: [-15, 35]
        });
        L.marker(coord, { icon: labelIcon }).addTo(labelLayer);

        L.circleMarker(coord, {
            radius: 7, 
            color: '#000', 
            fillColor: '#00FF00', 
            fillOpacity: 1, 
            weight: 3 
        }).addTo(labelLayer);
    }
</script>
</body>
</html>